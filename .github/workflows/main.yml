name: Build, Sign, and Release WinUI 3

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' 

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    env:
      Configuration: Release
      Platform: x64
      # Using the .slnx extension seen in your repository screenshot
      Solution_Path: "yolo venicle.slnx"
      Project_Path: "yolo venicle/yolo venicle.csproj"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Cache NuGet Packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Decode Certificate
      shell: powershell
      run: |
        $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_Pfx }}")
        $certificatePath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "GitHubActionsWorkflow.pfx"
        [IO.File]::WriteAllBytes($certificatePath, $pfx_cert_byte)

    - name: Restore NuGet Packages
      shell: powershell
      run: |
        # Explicitly disabling ReadyToRun during restore to avoid NETSDK1094
        & msbuild "$env:Solution_Path" /t:Restore `
          /p:Configuration=$env:Configuration `
          /p:RuntimeIdentifier=win-$env:Platform `
          /p:PublishReadyToRun=false

    - name: Build and Package
      shell: powershell
      run: |
        # Using the & operator and quotes to safely handle the space in "yolo venicle"
        & msbuild "$env:Project_Path" `
          /p:Configuration=$env:Configuration `
          /p:Platform=$env:Platform `
          /p:PublishReadyToRun=false `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:GenerateAppxPackageOnBuild=true `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="../GitHubActionsWorkflow.pfx" `
          /p:PackageCertificatePassword="${{ secrets.Pfx_Password }}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # Uses the tag name you pushed (e.g., v1.0.1)
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          **/AppPackages/**/*.msix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}