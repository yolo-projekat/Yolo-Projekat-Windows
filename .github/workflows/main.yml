name: Build, Sign, and Release WinUI 3

on:
  # 1. Allows you to click a "Run workflow" button in the GitHub Actions tab
  workflow_dispatch:

  # 2. Only triggers automatically if you push a tag (e.g., git push origin v1.0.0)
  push:
    tags:
      - 'v*' 

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    env:
      Solution_Path: "yolo venicle.sln"
      Project_Path: "yolo venicle/yolo venicle.csproj"
      Configuration: Release
      Platform: x64

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Cache NuGet Packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Decode Certificate
      shell: powershell
      run: |
        $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_Pfx }}")
        $certificatePath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "GitHubActionsWorkflow.pfx"
        [IO.File]::WriteAllBytes($certificatePath, $pfx_cert_byte)

    - name: Restore NuGet Packages
      shell: powershell
      run: |
        msbuild "$env:Solution_Path" /t:Restore /p:Configuration=$env:Configuration /p:RuntimeIdentifier=win-$env:Platform

    - name: Build and Package
      shell: powershell
      run: |
        msbuild "$env:Project_Path" `
          /p:Configuration=$env:Configuration `
          /p:Platform=$env:Platform `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:GenerateAppxPackageOnBuild=true `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="../GitHubActionsWorkflow.pfx" `
          /p:PackageCertificatePassword="${{ secrets.Pfx_Password }}"

    # Logic: Use the pushed tag if available, otherwise generate a new one
    - name: Generate or Use Tag
      id: tag_gen
      uses: anothrNick/github-tag-action@1.67.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DEFAULT_BUMP: patch

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag_gen.outputs.new_tag }}
        name: Release ${{ steps.tag_gen.outputs.new_tag }}
        draft: false
        prerelease: false
        files: |
          **/AppPackages/**/*.msix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}