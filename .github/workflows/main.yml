name: Build, Sign, and Release WinUI 3

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' 

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    env:
      Configuration: Release
      Platform: x64
      Solution_Path: "yolo venicle.slnx"
      Project_Path: "yolo venicle/yolo venicle.csproj"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Cache NuGet Packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Decode Certificate
      shell: powershell
      run: |
        $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.BASE64_ENCODED_Pfx }}")
        $certificatePath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "GitHubActionsWorkflow.pfx"
        [IO.File]::WriteAllBytes($certificatePath, $pfx_cert_byte)

    - name: Clean Build Folders
      shell: powershell
      run: |
        & msbuild "$env:Solution_Path" /t:Clean /p:Configuration=$env:Configuration /p:Platform=$env:Platform

    - name: Restore NuGet Packages
      shell: powershell
      run: |
        & msbuild "$env:Solution_Path" /t:Restore `
          /p:Configuration=$env:Configuration `
          /p:RuntimeIdentifier=win-$env:Platform `
          /p:PublishReadyToRun=false

    - name: Build and Package
      shell: powershell
      run: |
        & msbuild "$env:Project_Path" `
          /p:Configuration=$env:Configuration `
          /p:Platform=$env:Platform `
          /p:PublishReadyToRun=false `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:GenerateAppxPackageOnBuild=true `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="../GitHubActionsWorkflow.pfx" `
          /p:PackageCertificatePassword="${{ secrets.Pfx_Password }}"

    - name: Prepare Release Assets
      shell: powershell
      run: |
        $tag = "${{ github.ref_name }}"
        # Create a clean staging directory
        if (Test-Path "release_assets") { Remove-Item -Recurse -Force "release_assets" }
        New-Item -ItemType Directory -Path "release_assets"
        
        # 1. Find the main MSIX and rename it with the version tag
        $mainPackage = Get-ChildItem -Path "yolo venicle/AppPackages" -Filter "yolo venicle*.msix" -Recurse | Select-Object -First 1
        if ($mainPackage) {
            Copy-Item $mainPackage.FullName "release_assets/yolo-venicle-$tag.msix"
            Write-Host "Prepared main package: yolo-venicle-$tag.msix"
        }
        
        # 2. Find the runtime dependency (taking only the FIRST one found to avoid duplicates)
        $runtime = Get-ChildItem -Path "yolo venicle/AppPackages" -Filter "Microsoft.WindowsAppRuntime.1.8.msix" -Recurse | Select-Object -First 1
        if ($runtime) {
            Copy-Item $runtime.FullName "release_assets/Microsoft.WindowsAppRuntime.1.8.msix"
            Write-Host "Prepared runtime dependency."
        }

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: release_assets/*
        # NEW: If you re-run a build for the same tag, this prevents the "Already Exists" error
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}